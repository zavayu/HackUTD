# Implementation Plan

- [x] 1. Initialize project structure and dependencies
  - Create server directory with TypeScript configuration
  - Install core dependencies: express, mongoose, typescript, ts-node, @types packages
  - Install authentication dependencies: jsonwebtoken, bcryptjs, passport, passport-github2
  - Install AI dependencies: openai, langchain, @pinecone-database/pinecone
  - Install utility dependencies: dotenv, joi, winston, axios, node-cron, cors, helmet
  - Set up tsconfig.json with strict mode and ES2020 target
  - Create .env.example file with all required environment variables
  - Set up basic folder structure: src/models, src/routes, src/services, src/repositories, src/middleware, src/utils, src/config
  - _Requirements: 12.1_

- [x] 2. Set up database configuration and connection
  - Create MongoDB connection utility in src/config/database.ts
  - Implement connection pooling and error handling
  - Add connection retry logic with exponential backoff
  - Create database indexes setup script
  - _Requirements: 12.1, 12.2_

- [x] 3. Implement data models with Mongoose schemas
  - [x] 3.1 Create User model with validation
    - Define User schema with email, password, name, githubAccessToken fields
    - Add email uniqueness constraint and validation
    - Implement pre-save hook for password hashing with bcrypt (10 salt rounds)
    - Add method to compare passwords for login
    - _Requirements: 1.1, 1.5, 11.1_
  - [x] 3.2 Create Project model with relationships
    - Define Project schema with userId, name, description, status, connectedRepos fields
    - Add indexes on userId and status fields
    - Implement cascade delete for associated issues and sprints
    - _Requirements: 3.1, 3.5_
  - [x] 3.3 Create Issue model with embeddings support
    - Define Issue schema with projectId, sprintId, title, description, type, status, priority fields
    - Add acceptanceCriteria array and embeddingId field
    - Add indexes on projectId, sprintId, status, and priority
    - Implement validation for sprint-project relationship
    - _Requirements: 3.2, 3.4, 9.1_
  - [x] 3.4 Create Sprint model with date validation
    - Define Sprint schema with projectId, name, goal, startDate, endDate, status fields
    - Add validation to ensure endDate is after startDate
    - Add indexes on projectId and status
    - _Requirements: 3.3_
  - [x] 3.5 Create GitHubRepo model with nested documents
    - Define GitHubRepo schema with userId, fullName, accessToken, isActive, syncStatus fields
    - Add nested schemas for commits, pullRequests, and issues arrays
    - Implement encryption for accessToken field using crypto module
    - Add indexes on userId, isActive, and fullName (unique)
    - _Requirements: 2.3, 7.3_

- [x] 4. Implement authentication middleware and utilities
  - [x] 4.1 Create JWT utility functions
    - Implement generateToken function with 24-hour expiration
    - Implement verifyToken function with error handling
    - Add token payload interface with userId and iat claims
    - _Requirements: 1.2_
  - [x] 4.2 Create authentication middleware
    - Implement verifyToken middleware to extract and validate JWT from Authorization header
    - Attach decoded user information to request object
    - Return 401 error for missing, invalid, or expired tokens
    - _Requirements: 1.3, 1.4_
  - [x] 4.3 Create validation middleware factory
    - Implement validateBody, validateParams, validateQuery functions using Joi
    - Return 400 error with field-level validation details
    - Add input sanitization to prevent NoSQL injection
    - _Requirements: 11.1, 11.2, 11.3_
  - [x] 4.4 Create rate limiting middleware
    - Implement rate limiter with configurable window and max requests
    - Use in-memory store for tracking request counts per user
    - Return 429 error when limit exceeded
    - Configure different limits for standard (100/min), AI (10/min), and sync (5/min) endpoints
    - _Requirements: 11.4_

- [x] 5. Implement repository layer for data access
  - [x] 5.1 Create UserRepository
    - Implement create, findById, findByEmail, update, delete methods
    - Add error handling for duplicate email constraint
    - _Requirements: 1.1_
  - [x] 5.2 Create ProjectRepository
    - Implement create, findById, findByUserId, update, delete, countByUserId methods
    - Add pagination support for findByUserId
    - Filter queries by userId for authorization
    - _Requirements: 3.1, 11.5, 12.1_
  - [x] 5.3 Create IssueRepository
    - Implement create, findById, findByProjectId, findBySprintId, update, delete, deleteByProjectId methods
    - Add filtering support for status and priority
    - Use lean() for read-only queries
    - _Requirements: 3.2, 3.4, 12.1_
  - [x] 5.4 Create SprintRepository
    - Implement create, findById, findByProjectId, update, delete, deleteByProjectId methods
    - Add query optimization with select() for minimal fields
    - _Requirements: 3.3_
  - [x] 5.5 Create GitHubRepoRepository
    - Implement create, findById, findByUserId, update, delete, findAllActive methods
    - Add decryption logic for accessToken retrieval
    - _Requirements: 2.3, 7.1_

- [x] 6. Implement core service layer
  - [x] 6.1 Create AuthService
    - Implement register method with password hashing and user creation
    - Implement login method with password verification and JWT generation
    - Add email format validation
    - _Requirements: 1.1, 1.2, 1.5_
  - [x] 6.2 Create ProjectService
    - Implement createProject, getProject, listProjects, updateProject, deleteProject methods
    - Add authorization checks to verify user owns project
    - Implement cascade delete for issues and sprints on project deletion
    - Add pagination support for listProjects
    - _Requirements: 3.1, 3.5, 11.5, 12.3_
  - [x] 6.3 Create IssueService
    - Implement createIssue, getIssue, listIssues, updateIssue, deleteIssue, assignToSprint methods
    - Validate sprint belongs to same project when assigning
    - Add filtering by status, priority, and sprint
    - _Requirements: 3.2, 3.4_
  - [x] 6.4 Create SprintService
    - Implement createSprint, getSprint, listSprints, updateSprint, deleteSprint, getSprintIssues methods
    - Validate date ranges on creation and update
    - _Requirements: 3.3_

- [ ] 7. Implement GitHub OAuth and integration service
  - [ ] 7.1 Set up Passport GitHub OAuth strategy
    - Configure passport-github2 with client ID, secret, and callback URL
    - Implement OAuth callback handler to exchange code for access token
    - Store encrypted access token in user record
    - _Requirements: 2.1, 2.2, 2.3_
  - [ ] 7.2 Create GitHubService for API interactions
    - Implement fetchCommits method using GitHub REST API with date filtering (last 7 days)
    - Implement fetchPullRequests method to get open and recently merged PRs
    - Implement fetchIssues method to get open and recently closed issues
    - Add error handling for 401 responses to mark connection as invalid
    - Implement retry logic with exponential backoff (3 retries, starting at 30 seconds)
    - _Requirements: 2.5, 7.2, 7.4_
  - [ ] 7.3 Implement repository connection and sync
    - Create connectRepository method to validate repo access and store connection
    - Create disconnectRepository method to revoke token and delete repo data
    - Create syncRepository method to fetch and store commits, PRs, and issues
    - Update lastSyncTime and syncStatus after each sync attempt
    - _Requirements: 2.4, 7.3_

- [ ] 8. Implement vector embedding service
  - [ ] 8.1 Set up Pinecone client and index
    - Initialize Pinecone client with API key and environment
    - Create or connect to existing index with 1536 dimensions (OpenAI embedding size)
    - Add error handling for connection failures
    - _Requirements: 9.3_
  - [ ] 8.2 Create EmbeddingService
    - Implement generateEmbedding method using OpenAI embeddings API (text-embedding-ada-002)
    - Implement storeEmbedding method to upsert vectors to Pinecone with metadata
    - Implement searchSimilar method using cosine similarity to retrieve top K results
    - Implement deleteEmbeddings method with metadata filtering
    - Add timeout handling for embedding generation (5 seconds)
    - _Requirements: 9.1, 9.2, 9.3, 9.4_
  - [ ] 8.3 Integrate embeddings with Issue creation
    - Generate embedding for issue description after creation
    - Store embedding with metadata (sourceType: 'issue', sourceId, projectId)
    - Update issue record with embeddingId
    - Handle embedding failures gracefully without blocking issue creation
    - _Requirements: 9.1, 9.5_
  - [ ] 8.4 Integrate embeddings with GitHub sync
    - Generate embeddings for commit messages during sync
    - Generate embeddings for PR titles and descriptions
    - Store embeddings with appropriate metadata (sourceType, repoId)
    - Batch embedding generation for efficiency
    - _Requirements: 9.2_

- [ ] 9. Implement AI service with LangChain
  - [ ] 9.1 Create AIService base with context retrieval
    - Set up OpenAI client with GPT-4o model
    - Implement getProjectContext method to retrieve relevant embeddings
    - Create prompt templates using LangChain PromptTemplate
    - Add error handling for OpenAI API failures with 503 response
    - _Requirements: 4.5, 9.4_
  - [ ] 9.2 Implement user story generation
    - Create generateUserStories method accepting goal and project context
    - Build LangChain chain with prompt template for story generation
    - Retrieve similar issues using vector search for context
    - Parse OpenAI response to extract 3-10 user stories with acceptance criteria
    - Format stories as "As a [role], I want [feature], so that [benefit]"
    - Add timeout of 15 seconds for generation
    - _Requirements: 4.1, 4.2, 4.3, 4.4_
  - [ ] 9.3 Implement sprint summary generation
    - Create generateSprintSummary method accepting sprintId
    - Retrieve all sprint issues and calculate completion percentage
    - Fetch GitHub activity for connected repos if available
    - Build prompt with sprint data and GitHub context
    - Generate summary with completion, blockers, accomplishments, and risks
    - Return structured JSON response
    - Add timeout of 10 seconds
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_
  - [ ] 9.4 Implement backlog prioritization
    - Create prioritizeBacklog method accepting projectId
    - Retrieve all unprioritized issues (up to 50)
    - Use vector search to find related issues for context
    - Generate priority scores (1-100) with reasoning for each issue
    - Update issue records with priorityScore and reasoning
    - Add timeout of 20 seconds
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_
  - [ ] 9.5 Implement GitHub insights generation
    - Create generateGitHubInsights method accepting repoId and optional sprintId
    - Calculate metrics: commits per day, avg PR merge time, open issue count
    - Generate activity summary using OpenAI
    - If sprintId provided, compare sprint goals with GitHub activity for alignment analysis
    - Generate release readiness analysis (open PRs, failing checks, unresolved issues)
    - Return structured insights with metrics and recommendations
    - Add timeout of 15 seconds
    - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 10. Implement API routes and controllers
  - [ ] 10.1 Create authentication routes
    - POST /api/auth/register - validate input, call AuthService.register, return user and token
    - POST /api/auth/login - validate credentials, call AuthService.login, return token
    - GET /api/auth/github - initiate GitHub OAuth flow
    - GET /api/auth/github/callback - handle OAuth callback, store access token
    - Add Joi validation schemas for register and login
    - _Requirements: 1.1, 1.2, 2.1, 2.2_
  - [ ] 10.2 Create project routes
    - GET /api/projects - list user's projects with pagination
    - POST /api/projects - create new project with validation
    - GET /api/projects/:id - get project details with authorization check
    - PUT /api/projects/:id - update project with authorization check
    - DELETE /api/projects/:id - delete project with cascade
    - Add authentication middleware to all routes
    - Add Joi schemas for create and update
    - _Requirements: 3.1, 11.5_
  - [ ] 10.3 Create issue routes
    - GET /api/projects/:projectId/issues - list issues with filtering
    - POST /api/projects/:projectId/issues - create issue and trigger embedding generation
    - GET /api/projects/:projectId/issues/:id - get issue details
    - PUT /api/projects/:projectId/issues/:id - update issue
    - DELETE /api/projects/:projectId/issues/:id - delete issue
    - Add project ownership validation middleware
    - Add Joi schemas for create and update
    - _Requirements: 3.2, 9.1_
  - [ ] 10.4 Create sprint routes
    - GET /api/projects/:projectId/sprints - list sprints
    - POST /api/projects/:projectId/sprints - create sprint with date validation
    - GET /api/projects/:projectId/sprints/:id - get sprint with issues
    - PUT /api/projects/:projectId/sprints/:id - update sprint
    - DELETE /api/projects/:projectId/sprints/:id - delete sprint
    - Add project ownership validation middleware
    - Add Joi schemas for create and update
    - _Requirements: 3.3_
  - [ ] 10.5 Create AI assistant routes
    - POST /api/ai/generate-stories - accept goal, call AIService.generateUserStories
    - POST /api/ai/sprint-summary - accept sprintId, call AIService.generateSprintSummary
    - POST /api/ai/prioritize-backlog - accept projectId, call AIService.prioritizeBacklog
    - POST /api/ai/github-insights - accept repoId and optional sprintId, call AIService.generateGitHubInsights
    - Add AI-specific rate limiting (10 requests/min)
    - Add Joi validation for request bodies
    - _Requirements: 4.1, 5.1, 6.1, 8.1_
  - [ ] 10.6 Create GitHub integration routes
    - GET /api/github/repos - list user's connected repositories
    - POST /api/github/repos/connect - connect new repository with validation
    - DELETE /api/github/repos/:id - disconnect repository
    - POST /api/github/repos/:id/sync - trigger manual sync
    - GET /api/github/repos/:id/data - get synced repository data
    - Add sync-specific rate limiting (5 requests/min)
    - _Requirements: 2.4, 7.1, 7.3_

- [ ] 11. Implement error handling and logging
  - [ ] 11.1 Create custom error classes
    - Define AppError base class with statusCode, code, message, details
    - Create ValidationError, AuthenticationError, AuthorizationError, NotFoundError, ExternalServiceError classes
    - _Requirements: 10.2_
  - [ ] 11.2 Create error handling middleware
    - Implement global error handler to catch all errors
    - Format errors with consistent JSON structure including correlationId
    - Log errors with full stack trace and request context
    - Return appropriate status codes based on error type
    - _Requirements: 10.2, 10.3_
  - [ ] 11.3 Set up Winston logger
    - Configure Winston with JSON format for structured logging
    - Create separate transports for error and combined logs
    - Add correlation ID to all log entries
    - Implement log levels: ERROR, WARN, INFO, DEBUG
    - Log all API requests with method, path, status, and response time
    - _Requirements: 10.1, 10.4, 10.5_

- [ ] 12. Implement background sync jobs
  - [ ] 12.1 Create sync job scheduler
    - Set up node-cron to run every 15 minutes
    - Fetch all active repositories using GitHubRepoRepository.findAllActive
    - Process repositories sequentially to avoid rate limits
    - Call GitHubService.syncRepository for each repo
    - Log sync results with success/failure status and record counts
    - _Requirements: 7.1, 7.4, 10.5_
  - [ ] 12.2 Implement sync error handling
    - Catch sync failures and update syncStatus to 'failed'
    - Store error message in syncError field
    - Implement exponential backoff for failed syncs
    - Skip repositories that have failed 3+ consecutive times
    - _Requirements: 7.4_

- [ ] 13. Set up Express server and middleware
  - [ ] 13.1 Create main server file
    - Initialize Express app
    - Add helmet for security headers
    - Add cors middleware with frontend origin whitelist
    - Add express.json() for body parsing with size limit
    - Add compression middleware
    - Mount all route handlers
    - Add global error handling middleware
    - _Requirements: 11.1_
  - [ ] 13.2 Create health check endpoints
    - GET /health - return basic server status
    - GET /health/db - check MongoDB connection
    - GET /health/ai - verify OpenAI API availability
    - GET /health/vector - check Pinecone connection
    - _Requirements: 12.1_
  - [ ] 13.3 Start server and initialize connections
    - Connect to MongoDB with retry logic
    - Initialize Pinecone client
    - Start cron jobs for GitHub sync
    - Listen on configured port
    - Log startup information
    - _Requirements: 12.1_

- [ ] 14. Create environment configuration and documentation
  - [ ] 14.1 Create comprehensive .env.example
    - Document all required environment variables with descriptions
    - Include example values for development
    - Add comments for security-sensitive variables
    - _Requirements: 11.1_
  - [ ] 14.2 Create README.md for server
    - Document setup instructions and prerequisites
    - List all environment variables
    - Provide API endpoint documentation
    - Include development and deployment instructions
    - Add troubleshooting section
    - _Requirements: 12.1_
  - [ ]* 14.3 Create API documentation with examples
    - Document request/response formats for all endpoints
    - Include example curl commands
    - Document error codes and responses
    - Add authentication flow documentation
    - _Requirements: 11.2_

- [ ]* 15. Write unit tests for core services
  - [ ]* 15.1 Write tests for AuthService
    - Test user registration with valid and invalid data
    - Test login with correct and incorrect credentials
    - Test JWT generation and verification
    - Mock UserRepository
    - _Requirements: 1.1, 1.2_
  - [ ]* 15.2 Write tests for ProjectService
    - Test CRUD operations with authorization checks
    - Test cascade delete functionality
    - Test pagination
    - Mock ProjectRepository, IssueRepository, SprintRepository
    - _Requirements: 3.1, 3.5_
  - [ ]* 15.3 Write tests for AIService
    - Test user story generation with mocked OpenAI responses
    - Test sprint summary generation
    - Test backlog prioritization
    - Test GitHub insights generation
    - Mock OpenAI client and EmbeddingService
    - _Requirements: 4.1, 5.1, 6.1, 8.1_
  - [ ]* 15.4 Write tests for GitHubService
    - Test repository sync with mocked GitHub API
    - Test error handling for 401 responses
    - Test retry logic with exponential backoff
    - Mock axios for GitHub API calls
    - _Requirements: 7.2, 7.4_

- [ ]* 16. Write integration tests for API endpoints
  - [ ]* 16.1 Write tests for authentication endpoints
    - Test registration and login flows
    - Test JWT validation
    - Test GitHub OAuth flow
    - Use test MongoDB instance
    - _Requirements: 1.1, 1.2, 2.1_
  - [ ]* 16.2 Write tests for project management endpoints
    - Test complete CRUD operations
    - Test authorization enforcement
    - Test cascade deletes
    - Verify database state changes
    - _Requirements: 3.1, 3.5, 11.5_
  - [ ]* 16.3 Write tests for AI endpoints
    - Test story generation with mocked OpenAI
    - Test sprint summary generation
    - Test rate limiting on AI endpoints
    - Verify response formats
    - _Requirements: 4.1, 5.1, 11.4_
